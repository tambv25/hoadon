<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ƒê∆°n h√†ng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }

        .action-group {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .table-container {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .invoice-template {
            display: none;
            width: 80mm;
            padding: 2mm;
            margin: 20px auto;
            background: white;
            font-size: 12pt;
            border: 1px solid #ddd;
        }

        .invoice-header {
            font-size: 12px;
            line-height: 1.2;
            text-align: center;
            margin-bottom: 10px;
        }

        .invoice-title {
            text-align: center;
            font-weight: bold;
            font-size: 15pt;
            margin: 10px 0;
        }

        .invoice-details {
            text-align: center;
            font-weight: bold;
            line-height: 1.2;
            margin-bottom: 10px;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11.5px;
        }

        .invoice-table th,
        .invoice-table td {
            border-top: 0px solid rgb(118 116 116);
            border-bottom: 0.5px solid rgb(118 116 116);
            padding: 1mm 0.5mm;
        }

        .invoice-total {
            margin: 10px;
            font-size: 12px;
            line-height: 1.2;
            font-weight: 600;

        }

        .trai {
            float: left;
            width: 50%;
            text-align: left;
        }

        .phai {
            float: right;
            width: 50%;
            text-align: right;
        }



        .invoice-footer {
            margin-top: 20px;
            text-align: center;
        }

        .company-name {
            font-size: 16px;
            font-weight: bold;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            .invoice-table th,
            .invoice-table td {
                border-top: 0px solid rgb(118 116 116);
                border-bottom: 0.5px solid rgb(118 116 116);
                padding: 1mm 0.5mm;
            }

            #multiplePrintContainer,
            #multiplePrintContainer * {
                visibility: visible;
            }

            #multiplePrintContainer {
                position: absolute;
                left: 0;
                top: 0;
            }

            .invoice-template {
                page-break-after: always;
                page-break-inside: avoid;
                display: block;
                width: 80mm;
                margin-top: 0;
                font-size: 12px;
            }

            /* ƒê·∫£m b·∫£o h√≥a ƒë∆°n cu·ªëi c√πng kh√¥ng t·∫°o trang tr·ªëng */
            .invoice-template:last-child {
                page-break-after: avoid;
            }

            .cotten {
                width: 45%;

            }
        }
    </style>
</head>

<body class="bg-light">
    <div class="container mt-5">
        <h1 class="text-center mb-5 animate__animated animate__fadeInDown">Qu·∫£n l√Ω ƒê∆°n h√†ng</h1>
        <div class="action-group animate__animated animate__fadeInUp">
            <div class="row g-3">
                <div class="col-md-3">
                    <input type="text" id="searchInput" class="form-control" placeholder="T√¨m ki·∫øm t√™n, ƒë∆°n h√†ng...">
                </div>
                <div class="col-md-2">
                    <input type="date" id="startDate" class="form-control" placeholder="T·ª´ ng√†y">
                </div>
                <div class="col-md-2">
                    <input type="date" id="endDate" class="form-control" placeholder="ƒê·∫øn ng√†y">
                </div>
                <div class="col-md-2">
                    <select id="payment-method" class="form-select">
                        <option value="transfer" selected>Chuy·ªÉn kho·∫£n</option>
                        <option value="cash">Ti·ªÅn m·∫∑t</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select id="accountSelect" class="form-select" style="display: none;">
                        <option value="vpb">VPB: 113809086 - Ch·ªß TK: LE BICH NGOC</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <button id="printSelectedBtn" class="btn btn-primary w-100" data-bs-toggle="tooltip"
                        title="In ƒë∆°n h√†ng ƒë√£ ch·ªçn">
                        <i class="bi bi-printer"></i> In
                    </button>
                </div>
            </div>
        </div>
        <div class="table-container animate__animated animate__fadeIn">
            <table id="dataTable" class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th style="text-align: center; vertical-align: middle;"><input type="checkbox" id="selectAll"
                                class="form-check-input"></th>
                        <th style="text-align: center; vertical-align: middle;">Phi·∫øu BH</th>
                        <th style="text-align: center; vertical-align: middle;">Ng√†y order</th>
                        <th style="text-align: center; vertical-align: middle;">Kh√°ch h√†ng</th>
                        <th style="text-align: center; vertical-align: middle;">SƒêT</th>
                        <th style="text-align: center; vertical-align: middle;">ƒê·ªãa ch·ªâ</th>
                        <th style="text-align: center; vertical-align: middle;">Ph√≠ Ship</th>
                        <th style="text-align: center; vertical-align: middle;">T·ªïng Ti·ªÅn</th>
                        <th style="text-align: center; vertical-align: middle;">Gi·∫£m gi√°</th>
                        <th style="text-align: center; vertical-align: middle;">C√≤n Ph·∫£i Thanh To√°n</th>
                        <th style="text-align: center; vertical-align: middle;">Nh√¢n vi√™n b√°n</th>
                        <th style="text-align: center; vertical-align: middle;">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn v√†o ƒë√¢y b·ªüi JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="invoiceTemplate" class="invoice-template">
        <div class="invoice-header">
            <div class="company-name"><strong> SHOP NH√Ä NG·ªê</strong></div>
            <div><strong> CHUY√äN H√ÄNG X√ÅCH TAY THAILAND</strong></div>
            <div><strong> ƒêIA CH·ªà: 21 LINH ƒê∆Ø·ªúNG,LINH ƒê√ÄM.HN</strong></div>
            <div>SƒêT:0943 566 966</div>
            <div>üè¶ VP BANK: 113809086 L√™ B√≠ch Ng·ªçc</div>
        </div>
        <div class="invoice-title">H√ìA ƒê∆†N B√ÅN H√ÄNG</div>
        <div class="invoice-details">
            <div>KH√ÅCH H√ÄNG: <span id="invoiceCustomerName"></span></div>
            <div>SƒêT: <span id="invoiceCustomerPhone"></span></div>
            <div><span id="invoiceCustomerAddress"></span></div>
        </div>
        <table class="invoice-table">
            <tr>
                <th class="cotten">T√äN SP</th>
                <th>SL</th>
                <th style="text-align: right;">ƒê∆†N GI√Å</th>
                <th style="text-align: right;">T·ªîNG TI·ªÄN</th>
            </tr>
            <tbody id="invoiceItems"></tbody>
        </table>
        <div class="invoice-total">
            <div><span class="trai">T·ªïng ti·ªÅn: </span><span class="phai" id="invoiceTotal"></span></div>
            <div><span class="trai">Ph√≠ ship: </span><span class="phai" id="invoiceShipping"></span></div>
            <div><span class="trai">Gi·∫£m gi√°: </span><span class="phai" id="invoiceDiscount"></span></div>
            <div><span class="trai">ƒê√£ thanh to√°n: </span><span class="phai" id="invoicePaid"></span></div>
            <div><span class="trai">C√≤n ph·∫£i thanh to√°n: </span><span class="phai" id="invoiceRemaining"></span></div>
            <div><span>Ghi ch√∫: </span><span id="invoiceghichu"></span></div>
        </div>
        <div class="invoice-footer">
            <div id="accountInfo"></div>
            <div id="qrCodeText">Thanh to√°n QR Code</div>
            <div id="qrCodeContainer"></div>
            <div>C·∫£m ∆°n Qu√Ω kh√°ch, h·∫πn g·∫∑p l·∫°i!</div>
        </div>
    </div>

    <div id="multiplePrintContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script>
        const APP_ID = 'f4addc6b-0e3c-4920-a52d-3047369b2ae4';
        const API_KEY = 'V2-0VqkW-qgxkc-C42EP-aTrK1-SGylq-C5EPN-yt3Nd-pcYie';
        const SHEET_NAME_2 = 'B√°n h√†ng';
        let allData = [];
        let filteredData = [];
        let chiTietData = [];
        let dataTable;

        function apiRequest(tableName, action, data) {
            const apiUrl = `https://www.appsheet.com/api/v2/apps/${APP_ID}/tables/${tableName}/Action`;
            return fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'ApplicationAccessKey': API_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    Action: action,
                    Properties: {
                        Locale: 'vi-VN',
                        Timezone: 'Asia/Ho_Chi_Minh'
                    },
                    ...data
                })
            }).then(response => response.json());
        }

        function loadData() {
            Promise.all([
                apiRequest('B√°n h√†ng', 'Find', { Rows: [], Properties: { Selector: 'Filter(B√°n h√†ng, [Tr·∫°ng th√°i]="Ch·ªët order")' } }),
                apiRequest('Chi ti·∫øt b√°n h√†ng', 'Find', { Rows: [], Properties: { Selector: 'Filter(Chi ti·∫øt b√°n h√†ng, true)' } })
            ]).then(([banHangData, chiTietBanHangData]) => {
                allData = banHangData;
                filteredData = allData;
                chiTietData = chiTietBanHangData;
                initializeDataTable();
            }).catch(error => {
                console.error('Error loading data:', error);
            });
        }

        function initializeDataTable() {
            if (dataTable) {
                dataTable.destroy();
            }
            dataTable = $('#dataTable').DataTable({
                data: filteredData,
                columns: [
                    {
                        data: null,
                        render: function (data, type, row) {
                            return '<input type="checkbox" class="form-check-input order-checkbox" value="' + row.idban + '">';
                        }
                    },
                    { data: 'idban' },
                    { data: 'Ng√†y b√°n' },
                    { data: 'Kh√°ch h√†ng' },
                    { data: 'SƒêT' },
                    { data: 'ƒê·ªãa ch·ªâ' },
                    {
                        data: 'Ph√≠ ship',
                        render: function (data) {
                            return formatCurrency(data);
                        }
                    },
                    {
                        data: 'T·ªïng ti·ªÅn',
                        render: function (data) {
                            return formatCurrency(data);
                        }
                    },
                    {
                        data: 'Gi·∫£m gi√° theo ti·ªÅn',
                        render: function (data) {
                            return formatCurrency(data);
                        }
                    },
                    {
                        data: 'C√≤n ph·∫£i thanh to√°n',
                        render: function (data) {
                            return formatCurrency(data);
                        }
                    },
                    { data: 'Nh√¢n vi√™n b√°n' },
                    {
                        data: null,
                        render: function (data, type, row) {
                            return '<button class="btn btn-sm btn-info me-1" onclick="showOrderDetail(\'' + row.idban + '\')">Chi ti·∫øt</button>';
                        }
                    }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/vi.json'
                },
                pageLength: 10,
                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "T·∫•t c·∫£"]]
            });
        }

        function showOrderDetail(orderId) {
            const order = allData.find(item => item.idban === orderId);
            const orderDetails = chiTietData.filter(detail => detail.idban === orderId);
            const invoiceTemplate = document.getElementById('invoiceTemplate');

            document.getElementById('invoiceCustomerName').textContent = order['Kh√°ch h√†ng'];
            document.getElementById('invoiceCustomerPhone').textContent = order.SƒêT;
            document.getElementById('invoiceCustomerAddress').textContent = order['ƒê·ªãa ch·ªâ'];
            document.getElementById('invoiceTotal').textContent = formatCurrency(order['T·ªïng ti·ªÅn']);
            document.getElementById('invoiceShipping').textContent = formatCurrency(order['Ph√≠ ship']);
            document.getElementById('invoiceDiscount').textContent = formatCurrency(order['Gi·∫£m gi√° theo ti·ªÅn']);
            document.getElementById('invoicePaid').textContent = formatCurrency(order['ƒê√£ thanh to√°n'] || '0');
            document.getElementById('invoiceRemaining').textContent = formatCurrency(order['C√≤n ph·∫£i thanh to√°n']);
            document.getElementById('invoiceghichu').textContent = order['Ghi ch√∫'];

            const invoiceItems = document.getElementById('invoiceItems');
            invoiceItems.innerHTML = '';
            orderDetails.forEach(detail => {
                const row = invoiceItems.insertRow();
                row.insertCell().textContent = detail['T√™n s·∫£n ph·∫©m'];
                row.insertCell().textContent = detail['S·ªë l∆∞·ª£ng'];

                const dongiaCell = row.insertCell();
                dongiaCell.textContent = formatCurrency(detail['ƒê∆°n gi√°']);
                dongiaCell.style.textAlign = 'right';

                const totalCell = row.insertCell();
                totalCell.textContent = formatCurrency(detail['S·ªë l∆∞·ª£ng'] * detail['ƒê∆°n gi√°']);
                totalCell.style.textAlign = 'right';
            });

            updateQRCode(order);

            document.querySelector('.container').style.display = 'none';
            invoiceTemplate.style.display = 'block';

            const backButton = document.createElement('button');
            backButton.textContent = 'Quay l·∫°i';
            backButton.className = 'btn btn-secondary mt-3';
            backButton.onclick = function () {
                invoiceTemplate.style.display = 'none';
                document.querySelector('.container').style.display = 'block';
                invoiceTemplate.removeChild(backButton);
            };
            invoiceTemplate.appendChild(backButton);
        }

        function updatePaymentMethod() {
            const paymentMethod = document.getElementById('payment-method').value;
            const accountSelect = document.getElementById('accountSelect');
            const accountInfo = document.getElementById('accountInfo');
            const qrCodeText = document.getElementById('qrCodeText');

            if (paymentMethod === 'transfer') {
                accountSelect.style.display = 'block';
                accountInfo.style.display = 'block';
                accountInfo.textContent = accountSelect.options[accountSelect.selectedIndex].text;
                qrCodeText.style.display = 'block';
            } else {
                accountSelect.style.display = 'none';
                accountInfo.style.display = 'none';
                qrCodeText.style.display = 'none';
            }

            // C·∫≠p nh·∫≠t QR code n·∫øu c·∫ßn
            const selectedOrders = getSelectedOrders();
            if (selectedOrders.length > 0) {
                updateQRCode(selectedOrders[0]);
            }
        }
        // ƒê·∫£m b·∫£o r·∫±ng h√†m n√†y ƒë∆∞·ª£c g·ªçi khi thay ƒë·ªïi ph∆∞∆°ng th·ª©c thanh to√°n
        document.getElementById('payment-method').addEventListener('change', updatePaymentMethod);

        function updateQRCode(order, container = document) {
            const paymentMethod = document.getElementById('payment-method').value;
            const qrCodeContainer = container.querySelector('#qrCodeContainer');
            if (paymentMethod === 'transfer') {
                const amount = order['C√≤n ph·∫£i thanh to√°n'] || 0;
                const accountSelect = document.getElementById('accountSelect');
                const selectedAccount = accountSelect.options[accountSelect.selectedIndex];
                const bankInfo = selectedAccount.text.split(':')[0].trim();
                const accountNumber = selectedAccount.text.split(':')[1].split('-')[0].trim();
                const accountName = selectedAccount.text.split('-')[1].trim();

                const qrCodeUrl = `https://img.vietqr.io/image/${bankInfo}-${accountNumber}-compact.png?amount=${amount}&addInfo=Thanh toan don hang&accountName=${encodeURIComponent(accountName)}`;
                const qrCodeImg = document.createElement('img');
                qrCodeImg.src = qrCodeUrl;
                qrCodeImg.alt = "QR Code";
                qrCodeImg.style.width = "100px";
                qrCodeImg.style.height = "100px";
                qrCodeContainer.innerHTML = '';
                qrCodeContainer.appendChild(qrCodeImg);
            } else {
                qrCodeContainer.innerHTML = '';
            }
        }

        function printMultipleInvoices(selectedOrders) {
            const printContainer = document.getElementById('multiplePrintContainer');
            printContainer.innerHTML = '';

            selectedOrders.forEach((order, index) => {
                const invoiceTemplate = document.getElementById('invoiceTemplate').cloneNode(true);
                invoiceTemplate.id = `invoice-${order.idban}`;
                invoiceTemplate.style.display = 'block';

                // ƒêi·ªÅn th√¥ng tin h√≥a ƒë∆°n
                fillInvoiceTemplate(invoiceTemplate, order);

                // Th√™m page-break cho t·∫•t c·∫£ tr·ª´ h√≥a ƒë∆°n cu·ªëi c√πng
                if (index < selectedOrders.length - 1) {
                    invoiceTemplate.style.pageBreakAfter = 'always';
                }

                printContainer.appendChild(invoiceTemplate);
            });

            // ·∫®n container ch√≠nh v√† hi·ªÉn th·ªã container in
            document.querySelector('.container').style.display = 'none';
            printContainer.style.display = 'block';

            // ƒê·ª£i DOM c·∫≠p nh·∫≠t v√† in
            setTimeout(() => {
                window.print();
                // Sau khi in xong, kh√¥i ph·ª•c l·∫°i giao di·ªán
                setTimeout(() => {
                    document.querySelector('.container').style.display = 'block';
                    printContainer.style.display = 'none';
                    printContainer.innerHTML = '';
                }, 100);
            }, 500);
        }

        // H√†m ph·ª• tr·ª£ ƒë·ªÉ ƒëi·ªÅn th√¥ng tin h√≥a ƒë∆°n
        function fillInvoiceTemplate(template, order) {
            template.querySelector('#invoiceCustomerName').textContent = order['Kh√°ch h√†ng'];
            template.querySelector('#invoiceCustomerPhone').textContent = order.SƒêT;
            template.querySelector('#invoiceCustomerAddress').textContent = order['ƒê·ªãa ch·ªâ'];
            template.querySelector('#invoiceTotal').textContent = formatCurrency(order['T·ªïng ti·ªÅn']);
            template.querySelector('#invoiceShipping').textContent = formatCurrency(order['Ph√≠ ship']);
            template.querySelector('#invoiceDiscount').textContent = formatCurrency(order['Gi·∫£m gi√° theo ti·ªÅn']);
            template.querySelector('#invoicePaid').textContent = formatCurrency(order['ƒê√£ thanh to√°n'] || '0');
            template.querySelector('#invoiceRemaining').textContent = formatCurrency(order['C√≤n ph·∫£i thanh to√°n']);
            template.querySelector('#invoiceghichu').textContent = order['Ghi ch√∫'];

            // ƒêi·ªÅn chi ti·∫øt ƒë∆°n h√†ng
            const invoiceItems = template.querySelector('#invoiceItems');
            invoiceItems.innerHTML = '';
            const orderDetails = chiTietData.filter(detail => detail.idban === order.idban);
            orderDetails.forEach(detail => {
                const row = invoiceItems.insertRow();
                row.insertCell().textContent = detail['T√™n s·∫£n ph·∫©m'];
                row.insertCell().textContent = detail['S·ªë l∆∞·ª£ng'];

                const dongiaCell = row.insertCell();
                dongiaCell.textContent = formatCurrency(detail['ƒê∆°n gi√°']);
                dongiaCell.style.textAlign = 'right';

                const totalCell = row.insertCell();
                totalCell.textContent = formatCurrency(detail['S·ªë l∆∞·ª£ng'] * detail['ƒê∆°n gi√°']);
                totalCell.style.textAlign = 'right';
            });

            // C·∫≠p nh·∫≠t m√£ QR
            updateQRCode(order, template);
        }

        function formatCurrency(value) {
            if (!value) return '0';
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' })
                .format(value)
                .replace('‚Ç´', '')  // Lo·∫°i b·ªè k√Ω t·ª± ƒë·ªìng
                .trim();  // Lo·∫°i b·ªè kho·∫£ng tr·∫Øng th·ª´a n·∫øu c√≥
        }

        function getSelectedOrders() {
            const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
            const selectedOrderIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            return allData.filter(order => selectedOrderIds.includes(order.idban));
        }

        function searchOrders() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            filteredData = allData.filter(order => {
                const matchesSearch = order.idban.toLowerCase().includes(searchTerm) ||
                    order['Kh√°ch h√†ng'].toLowerCase().includes(searchTerm) ||
                    order.SƒêT.includes(searchTerm);

                const orderDate = new Date(order['Ng√†y b√°n']);
                const matchesStartDate = !startDate || orderDate >= new Date(startDate);
                const matchesEndDate = !endDate || orderDate <= new Date(endDate);

                return matchesSearch && matchesStartDate && matchesEndDate;
            });

            initializeDataTable();
        }

        // Event Listeners
        document.getElementById('selectAll').addEventListener('change', function () {
            const checkboxes = document.querySelectorAll('.order-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });

        document.getElementById('printSelectedBtn').addEventListener('click', function () {
            const selectedOrders = getSelectedOrders();
            if (selectedOrders.length > 0) {
                printMultipleInvoices(selectedOrders);
            } else {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ƒë∆°n h√†ng ƒë·ªÉ in.');
            }
        });

        document.getElementById('payment-method').addEventListener('change', function () {
            updatePaymentMethod();
            const selectedOrders = getSelectedOrders();
            if (selectedOrders.length > 0) {
                updateQRCode(selectedOrders[0]);
            }
        });

        document.getElementById('accountSelect').addEventListener('change', function () {
            const selectedOrders = getSelectedOrders();
            if (selectedOrders.length > 0) {
                updateQRCode(selectedOrders[0]);
            }
        });

        document.getElementById('searchInput').addEventListener('input', searchOrders);
        document.getElementById('startDate').addEventListener('change', searchOrders);
        document.getElementById('endDate').addEventListener('change', searchOrders);

        // Initialization
        window.onload = function () {
            loadData();
            updatePaymentMethod();

            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });
        };
    </script>
</body>

</html>
